{% extends "base.html" %} 

{% block title %}<title>Incident Reports</title>{% endblock %}

{% block css %}
{{block.super}}
<link rel="stylesheet" href="http://ol3js.org/en/master/css/ol.css" type="text/css">
    <style>
      .map {
        height: 400px;
        width: 100%;
      }
      #popup {
        width: 170px;
        height: 40px;
        margin-left: -92px;
        margin-bottom: 12px;
        border-radius: 5px;
        padding: 5px;
        background-color: white;
      }
    </style>
{% endblock %}

{% block content %}
<div id="popup">
</div>
<h3>Incident Reports</h3>
<div id="coords"></div>
<p>Last 30 Incidents in the Portland area</p>
<button id="popover" data-title="some kewl stff">Stuff</button>
<div id="map" class="map"></div>
{% endblock %}

{% block js %}
{{block.super}}
<script src="http://ol3js.org/en/master/build/ol.js" type="text/javascript"></script>
<!--script src="http://www.mapquestapi.com/sdk/leaflet/v1.0/mq-map.js?key=Fmjtd%7Cluur2q6r29%2C20%3Do5-9a25qw"></script-->
<script>
$(document).ready(function(){
        $('#popover').popover();

    var image = new ol.style.Circle({
      radius: 5,
      fill: new ol.style.Fill({color:'#C90000'}),
      stroke: new ol.style.Stroke({color: 'red', width: 1})
    });

    var styles = {
      'Point': [new ol.style.Style({
        image: image
      })],
      'LineString': [new ol.style.Style({
        stroke: new ol.style.Stroke({
          color: 'green',
          width: 1
        })
      })],
      'MultiLineString': [new ol.style.Style({
        stroke: new ol.style.Stroke({
          color: 'green',
          width: 1
        })
      })],
      'MultiPoint': [new ol.style.Style({
        image: image
      })],
      'MultiPolygon': [new ol.style.Style({
        stroke: new ol.style.Stroke({
          color: 'yellow',
          width: 1
        }),
        fill: new ol.style.Fill({
          color: 'rgba(255, 255, 0, 0.1)'
        })
      })],
      'Polygon': [new ol.style.Style({
        stroke: new ol.style.Stroke({
          color: 'blue',
          lineDash: [4],
          width: 3
        }),
        fill: new ol.style.Fill({
          color: 'rgba(0, 0, 255, 0.1)'
        })
      })],
      'GeometryCollection': [new ol.style.Style({
        stroke: new ol.style.Stroke({
          color: 'magenta',
          width: 2
        }),
        fill: new ol.style.Fill({
          color: 'magenta'
        }),
        image: new ol.style.Circle({
          radius: 10,
          fill: null,
          stroke: new ol.style.Stroke({
            color: 'magenta'
          })
        })
      })],
      'Circle': [new ol.style.Style({
        stroke: new ol.style.Stroke({
          color: 'red',
          width: 2
        }),
        fill: new ol.style.Fill({
          color: 'rgba(255,0,0,0.2)'
        })
      })]
    };

    var styleFunction = function(feature, resolution) {
      return styles[feature.getGeometry().getType()];
    };

    var map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.MapQuest({layer: 'osm'})
            }),
            new ol.layer.Image({
                source: new ol.source.ImageVector({
                    source: new ol.source.GeoJSON({
                      projection: 'EPSG:3857',
                      url: '{{STATIC_URL}}city_fill_4326.geojson'
                    }),
                    style: new ol.style.Style({
                      fill: new ol.style.Fill({
                        color: 'rgba(255, 255, 255, 0.6)'
                      }),
                      stroke: new ol.style.Stroke({
                        color: '#319FD3',
                        width: 1
                      })
                    })
                })
            })
        ],
        view: new ol.View2D({
            center: ol.proj.transform([-122.642738, 45.522635], 'EPSG:4326', 'EPSG:3857'),
            zoom: 10
        })
    });

    var element = document.getElementById('popup');

    var popup = new ol.Overlay({
        map: map,
        element: element
    });

    var featureOverlay = new ol.FeatureOverlay({
        map: map,
        style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                color: '#f00',
                width: 1
            }),
            fill: new ol.style.Fill({
                color: 'rgba(255,0,0,0.1)'
            })
        })
    });
                

    var highlight;
    var displayFeatureInfo = function(pixel) {
        var feature = map.forEachFeatureAtPixel(pixel, function(feature, layer) {
            return feature;
        });
        if (feature !== highlight) {
            if (highlight) {
                featureOverlay.removeFeature(highlight);
            }
            if (feature) {
                featureOverlay.addFeature(feature);
            }
            highlight = feature;
        }

    };

    $(map.getViewport()).on('mousemove', function(evt){
        var pixel = map.getEventPixel(evt.originalEvent);
        displayFeatureInfo(pixel);
        var pixel = map.getEventPixel(evt.originalEvent);
        var feature = map.forEachFeatureAtPixel(pixel,
            function(feature, layer) {
                return feature;
        });
        if(feature){
            geom = feature.getGeometry();

            $('#coords').text(evt.coordinate[0] + ':' + evt.coordinate[1]);
        }
    });

    map.on('click', function(evt){
  var coordinate = evt.coordinate;
  var hdms = ol.coordinate.toStringHDMS(ol.proj.transform(
      coordinate, 'EPSG:3857', 'EPSG:4326'));

  overlay.setPosition(coordinate);
  content.innerHTML = '<p>You clicked here:</p><code>' + hdms +
      '</code>';
  container.style.display = 'block';
        var coordinate = evt.coordinate;
        var pixel = map.getEventPixel(evt.originalEvent);
        var feature = map.forEachFeatureAtPixel(pixel,
            function(feature, layer) {
                return feature;
        });
        if (feature) {
            popup.setPosition(coordinate);
            $(element).popover({
                'placement': 'top',
                'html': true,
                'content': feature.get('CITYNAME')
            });
            $(element).popover('show');
        } else {
            $(element).popover('destroy');
        }
    });

    map.on('hover', function(evt){
    });

    //var map;
    //var ajaxRequest;
    //var plotlist;
    //var plotlayers=[];

    //function initmap() {
    //    // set up the map
    //    map = new L.Map('map');

    //    // create the tile layer with correct attribution
    //    var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    //    var osmAttrib='Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
    //    var osm = new L.TileLayer(osmUrl, {minZoom: 8, maxZoom: 18, attribution: osmAttrib});		

    //    // start the map in South-East England
    //    map.setView(new L.LatLng(45.522635, -122.642738), 12);
    //    map.addLayer(osm);

    //    {% for ir in incident_reports %}
    //    L.marker([{{ir.lat}}, {{ir.long}}]).addTo(map).bindPopup(
    //        '<p><i>{{ir.date_time}}</i></p><p>{{ir.description}}</p>');
    //    {% endfor %}
    //}

    //initmap();

    // var map = L.map('map', {
    //         layers: MQ.mapLayer(),
    //         center: [45.522635, -122.642738],
    //         zoom: 10
    // });

    // var myStyle = {
    //     "color": "#ff7800",
    //     "weight": 5,
    //     "opacity": 0.65
    // };

    // 
    // $.getJSON('{{STATIC_URL}}regions.geojson', function(data){
    //     L.geoJson(data).addTo(map, {
    //         style: myStyle
    //     });
    // });

    // {% for ir in incident_reports %}
    // L.marker([{{ir.lat}}, {{ir.long}}]).addTo(map).bindPopup(
    //     '<p><i>{{ir.date_time}}</i></p><p>{{ir.description}}</p>');
    // {% endfor %}
});
</script>
{% endblock %}
